var ls = window.localStorage;
var createItemListNum = 0;
var file = document.getElementById("uploadImgFile");
ls.setItem("button-id", 0);

function deleteAnimate(obj) {
    $(obj).fadeTo("slow", 0.03, function () {
        $(this).slideUp("slow", function () {
            $(this).remove();
        });
    });
}

function createItem(obj, createType) {
    var _bid = $(obj).attr("data-button-id");
    var _bindEle = $(".show-item-content" + _bid);
    ls.setItem("button-id", _bid);
    switch (createType) {
        case"image":
            addImgItem(_bindEle);
            break;
        case"text":
            var _bindEle = $(".item-list-right" + _bid);
            insertText(_bindEle, _bid);
            break;
        case"video":
            insertVideo(_bindEle, _bid);
            break;
        case"delete":
            var _em = $(".show-item-content" + _bid).children();
            askDeleteConfirm(_em);
            break
    }
}

function removeItemList(obj) {
    var _em = $(obj).parent().parent();
    askDeleteConfirm(_em)
}

function addImgItem() {
    file.click()
}

file.onchange = function () {
    insertImage()
};

function getLsButtonId() {
    var _bid = ls.getItem("button-id") || 0;
    return _bid
}

function insertImage() {
    LayerShow("正在上传，请稍侯...");
    var FileController = "/index/article/uploadimg";
    var form = new FormData();
    form.append("file", file.files[0]);
    var xhr = new XMLHttpRequest();
    var overTime = false;
    var timer = setTimeout(function () {
        overTime = true;
        xhr.abort();
    }, 15 * 1000);
    xhr.open("post", FileController, true);
    xhr.onload = function (data) {
        if (overTime) {
            LayerHide();
            showNoticeBox('', '网络好像出了点差错~超时了', '朕知道了');
            return;
        }
        clearTimeout(timer);
        try {
            var obj = JSON.parse(data.currentTarget.response);
        } catch (e) {
            LayerHide();
            showNoticeBox('', '该图片不支持，换其他图片试试呗~', '朕知道了');
            return;
        }
        if (typeof obj != 'object') {
            LayerHide();
            showNoticeBox('', '该图片不支持，换其他图片试试呗~', '朕知道了');
            return;
        }
        if (obj.errcode == 200) {
            var img = document.createElement("img");
            img.setAttribute("src", obj.data);
            img.setAttribute("class", "insert_img");
            img.setAttribute("style", "margin-bottom:15px;");
            var _bid = getLsButtonId();
            $(".show-item-content" + _bid).html(img);
            file.value = "";
            LayerHide()
        } else {
            alert(obj.msg);
            LayerHide()
        }
    };
    xhr.send(form)
}

function askDeleteConfirm(obj) {
    confirms("", "你真的要删除吗?");
    document.getElementById("confirmDelete").addEventListener("click", function () {
        deleteAnimate(obj);
        /*$(obj).remove()*/
    });
    document.getElementById("confirmNoDelete").addEventListener("click", function () {
    })
}

function insertTitle(obj) {
    var _text = $(obj).val();
    showTextBox("", "", "请输入文章标题", _text);
    document.getElementById("insertTitleConfirm").addEventListener("click", function () {
        var promptObtain = document.getElementsByName("promptObtain")[0].value;
        var _txt = delHtmlTag(promptObtain);
        $(obj).val(_txt);
        ls.setItem("_lsTitle", delHtmlTag(_txt))
    });
    document.getElementById("insertTitleNoConfirm").addEventListener("click", function () {
    })
}

function insertText(obj) {
    var _text = $(obj).html();
    showTextareaBox("", "", "请输入内容", _text);
    document.getElementById("insertTextConfirm").addEventListener("click", function () {
        var promptObtain = document.getElementsByName("promptObtain")[0].value;
        var _bid = getLsButtonId();
        $(".item-list-right" + _bid).text(delHtmlTag(promptObtain))
    });
    document.getElementById("insertTextNoConfirm").addEventListener("click", function () {
    })
}

function insertLink() {
    showLinkBox("", "", ["请输入链接文字", "请输入链接地址"]);
    document.getElementById("insertLinkConfirm").addEventListener("click", function () {
        var promptObtain = document.getElementsByName("promptObtain")[0].value;
        var promptObtain1 = document.getElementsByName("promptObtain")[1].value;
        if ("" == promptObtain) {
            document.getElementById("popup-err1").style.display = "block";
            return false
        }
        if (!checkUrl(promptObtain1)) {
            document.getElementById("popup-err1").style.display = "none";
            document.getElementById("popup-err2").style.display = "block";
            return false
        }
        var _bid = getLsButtonId();
        $(".item-list-right" + _bid).apend('<a href="' + promptObtain1 + '">' + promptObtain + "</a>")
    });
    document.getElementById("insertLinkNoConfirm").addEventListener("click", function () {
    })
}

var video_index = 0;

function anysVideo(videoUrl) {
    $.post("/index/Media/AnalysisVideo", {"video_url": videoUrl, "from": "origin"}, function (res) {
        if (res.errcode == 0) {
            var _bid = getLsButtonId();
            $(".show-item-content" + _bid).html(res.videoSource)
        } else {
            alert(res.msg)
        }
    }, "json");
    video_index++
}

function insertVideo(obj) {
    showVideoBox("", "", "请输入视频链接");
    document.getElementById("insertVideoConfirm").addEventListener("click", function () {
        var videoUrl = document.getElementsByName("promptObtain")[0].value;
        if (!checkUrl(videoUrl)) {
            document.getElementById("popup-err2").style.display = "block";
            return false
        }
        anysVideo(videoUrl)
    });
    document.getElementById("insertVideoNoConfirm").addEventListener("click", function () {
    })
}

function createItemList(obj) {
    createItemListNum++;
    var _html = '<div class="create-item-list-warp create-item-list-warp' + createItemListNum + '" style="display:none;">                <div class="create-item-list" data-button-id="' + createItemListNum + '" style="position: relative;">                <div class="item-list-box">                <div class="item-list-left show-icon' + createItemListNum + '">                <div class="item-list-left-content">                <div class="show-item-content inputForm show-item-content' + createItemListNum + '" placeholder="请点击下方图标添加图片/视频内容"></div>                <div class="toolbar">                <div class="toolbar-item">                <a href="javascript:;" data-button-id="' + createItemListNum + '" onClick="createItem(this,\'image\')"><img src="/static/test/add.png"/></a>                <a href="javascript:;" data-button-id="' + createItemListNum + '" onClick="createItem(this,\'video\')"><img src="/static/test/add_video.png"/></a>                <a href="javascript:;" data-button-id="' + createItemListNum + '" onClick="createItem(this,\'delete\')"><img src="/static/test/delete.png"/></a>                </div>                </div>                </div>                </div>                <div class="item-list-right inputForm item-list-right' + createItemListNum + '" data-button-id="' + createItemListNum + '" onClick="createItem(this,\'text\')" placeholder="请点击这里添加文字内容"></div>                </div>                <button class="show-btn delete-btn" data-button-id="' + createItemListNum + '" onClick="removeItemList(this)">x</button>                </div>                <div class="btn-area btn-two-buttons">                <button class="show-btn" data-button-id="' + createItemListNum + '" onClick="createItemList(this)">+</button>                </div>                </div>';
    $(obj).parent().parent().after(_html);
    $('.create-item-list-warp' + createItemListNum).fadeIn(1000);
}

function insertAfter(newElement, targetElement) {
    var parent = targetElement.parentNode;
    if (parent.lastChild == targetElement) {
        parent.appendChild(newElement, targetElement)
    } else {
        parent.insertBefore(newElement, targetElement.nextSibling)
    }
}

function showReviewBox() {
    var _html = ls.getItem("_lsData");
    var _title = ls.getItem("_lsTitle");
    var _content = "";
    var _jsonHtml = JSON.parse(_html);
    for (var i = 0; i < _jsonHtml.length; i++) {
        var _jsonObj = JSON.parse(_jsonHtml[i]);
        var _myTxt = _jsonObj.text;
        var newStr = _myTxt.replace(/http[s]?:\/\/[\w.]+\.(com|org|net|cn)[^ |\r\n]*/g, '<a href="$&">$&</a>');
        newStr = line2br(newStr);
        _content += "<p>" + newStr + "</p>" + "" + _jsonObj.media
    }
    $("#review-title").val(_title);
    $("#review-title").attr("placeholder", _title);
    $("#origin-content").html(_content);
    $("#origin-content iframe").each(function () {
        $(this).attr("width", "320px");
        $(this).attr("height", "240px")
    })
}

function delHtmlTag(str) {
    return str.replace(/<[^>]+>/g, "")
}

function line2br(text) {
    return text.split("\n").join("<br/>")
}

function checkContent() {
    var checkContent = [];
    $(".create-item-list-warp").each(function () {
        var _text1 = $(this).find(".show-item-content").html();
        var _text2 = $(this).find(".item-list-right").html();
        if (_text1 || _text2) {
            checkContent.push(1)
        }
    });
    if (checkContent.length == 0) {
        return false
    } else {
        return true
    }
}

function nextStep(obj) {
    var _title = $(".title input").val();
    if (_title == "" || _title == null) {
        showNoticeBox("", "标题忘记填写了吧！", "朕知道了");
        return false
    }
    if (!checkContent()) {
        showNoticeBox("", "文字或图片内容总得写点什么吧？！", "朕知道了");
        return false
    }
    var listWarp = $(".create-item-list-warp");
    if (typeof listWarp != "undefined") {
        var _formData = _lsData = [];
        $(".create-item-list-warp").each(function () {
            var _media = $(this).find(".show-item-content").html();
            var _text = $(this).find(".item-list-right").html();
            var _json = {"media": _media, "text": _text};
            _lsData.push(JSON.stringify(_json));
            _formData.push()
        });
        ls.setItem("_lsData", JSON.stringify(_formData));
        showReviewBox();
        if (ls.getItem("_lsData") != "" && ls.getItem("_lsData") != null) {
            ls.setItem("window_height", $(window).height());
            ls.setItem("window_width", $(window).width());
            var _title = ls.getItem("_lsTitle");
            $("#review-title").val(_title);
            $("#review-title").attr("placeholder", _title);
            var _html = document.getElementById("show-review-box").innerHTML;
            var pageii = layer.open({
                type: 1,
                content: _html,
                anim: "up",
                style: "position:fixed; left:0; top:0; width:100%; height:" + ls.getItem("window_height") + "px; overflow-y:scroll; border: none; -webkit-animation-duration: .5s; animation-duration: .5s;"
            })
        }
    } else {
        showNoticeBox("", "内容不能为空！", "朕知道了");
        return false
    }
}

function saveOrigin(obj) {
    removeWastTags();
    $("#bianjie_content_22reljxts").find("*").removeClass("selected_item");
    var title = $('.review-box-wrap input[name="title"]').attr("placeholder");
    $("#origin-content").find(".rich_media_content").attr("id", "").removeClass("rich_media_content");
    var content = $("#origin-content").html();
    content = '<div class="rich_media_content" id="js_content">' + content + "</div>";
    var cover = $("#origin-content").find("img").eq(0).attr("src");
    $('.save_form_22reljxts input[name="title"]').val(title);
    $('.save_form_22reljxts input[name="cover"]').val(cover);
    $('.save_form_22reljxts textarea[name="content"]').val(content);
    $('.save_form_22reljxts input[name="json_data"]').val(ls.getItem("_lsData"));
    if (!title) {
        showNoticeBox("", "文章标题不能为空,返回添加下呗！", "朕知道了");
    }
    if (!content || content == "<p></p>" || content == '<div class="rich_media_content" id="js_content"><p></p></div>') {
        showNoticeBox("", "文章内容不能为空,返回添加下呗！", "朕知道了");
        return false;
    }
    $(obj).attr("disabled", true);
    layer.open({type: 2, content: "正在保存中，请稍侯..."});
    $.post("/index/article/save", $(".save_form_22reljxts").serialize(), function (res) {
        layer.open({content: res.msg, skin: "msg", time: 3});
        $(obj).removeAttr("disabled");
        if (res.errcode == 200) {
            window.location.href = res.data
        }
    })
};